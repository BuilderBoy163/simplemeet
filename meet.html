<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SimpleMeet++ — Multi-Peer</title>
<style>
:root{--bg1:#071023;--bg2:#0b1a2b;--accent1:#7dd3fc;--accent2:#a78bfa;--muted:#98a8bf;--glass:rgba(255,255,255,0.06);--highlight:#7dd3fc}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto;color:#eaf2ff;background:linear-gradient(180deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased}
.app{max-width:1200px;margin:20px auto;padding:18px;display:flex;flex-direction:column;gap:16px}
header{display:flex;align-items:center;gap:14px}
.brand{font-weight:800;font-size:20px;background:linear-gradient(90deg,var(--accent1),var(--accent2))text;color:transparent}
.glass{background:var(--glass);border:1px solid rgba(255,255,255,0.06);backdrop-filter: blur(8px);padding:10px;border-radius:12px;color:var(--muted)}
.btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
.btn-main{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#042135}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
main{display:flex;gap:16px}
.grid{flex:1;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;padding:10px}
.tile{position:relative;border-radius:14px;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.2));border:1px solid rgba(255,255,255,0.04);box-shadow:0 8px 30px rgba(2,6,23,0.6);transition:all 0.3s ease;aspect-ratio:16/9}
.tile video{width:100%;height:100%;object-fit:cover;display:block}
.meta{position:absolute;left:10px;bottom:10px;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg, rgba(0,0,0,0.5), rgba(0,0,0,0.25));font-weight:700;font-size:13px;display:flex;align-items:center;gap:4px}
.side{width:360px;display:flex;flex-direction:column;gap:12px}
.panel{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.24));border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(10px)}
textarea{width:100%;height:92px;background:transparent;border:1px dashed rgba(255,255,255,0.04);color:inherit;padding:8px;border-radius:8px}
.chat-area{height:200px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}
.chat-input{display:flex;gap:8px;margin-top:8px}
input[type=text]{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
button.small{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.02)}
.status{font-size:13px;color:var(--muted)}
@media (max-width:980px){.side{display:none}.grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}}
</style>
</head>
<body>
<div class="app">
<header>
  <div class="brand">SimpleMeet++</div>
  <div class="glass">
    <label style="font-size:12px;color:var(--muted)">Room</label>
    <input id="room" placeholder="room-1" value="room-1" />
  </div>
  <div style="margin-left:auto;display:flex;gap:8px">
    <button id="joinBtn" class="btn btn-main">Join</button>
    <button id="leaveBtn" class="btn btn-ghost" style="display:none">Leave</button>
  </div>
</header>

<main>
  <div class="grid" id="grid"></div>
  <aside class="side">
    <div class="panel">
      <h4>Preview</h4>
      <div class="tile" style="min-height:120px"><video id="local" autoplay muted playsinline></video><div class="meta">You</div></div>
    </div>
    <div class="panel">
      <h4>Chat</h4>
      <div class="chat-area" id="chatArea"></div>
      <div class="chat-input"><input id="chatInput" placeholder="Say something..."/><button id="sendChat" class="small">Send</button></div>
    </div>
    <div class="panel">
      <h4>Status</h4>
      <div id="status" class="status">Idle</div>
    </div>
  </aside>
</main>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://wzaimsgnwsxgndlpyeiw.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6YWltc2dud3N4Z25kbHB5ZWl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMDQwODMsImV4cCI6MjA3OTY4MDA4M30.FNIBYc0GikZTJnKHW5FiqBfs7MwSB5nlnoMIlEFl8v0';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

const stunServers = [
  { urls: 'stun:stun.l.google.com:19302' },
  { urls: 'stun:stun1.l.google.com:19302' },
  { urls: 'stun:stun2.l.google.com:19302' }
];

const localV = document.getElementById('local');
const grid = document.getElementById('grid');
const statusEl = document.getElementById('status');
const chatArea = document.getElementById('chatArea');
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChat');
const joinBtn = document.getElementById('joinBtn');
const leaveBtn = document.getElementById('leaveBtn');
const roomInput = document.getElementById('room');

let localStream = null;
let peers = {}; // store {id: {pc, dc, videoEl}}

function logStatus(msg){ statusEl.textContent = msg; }
function addChat(msg, from='me'){ 
  const d = document.createElement('div'); 
  d.textContent = (from ? from + ': ' : '') + msg; 
  chatArea.appendChild(d); 
  chatArea.scrollTop = chatArea.scrollHeight; 
}

async function startLocal(){
  try {
    localStream = await navigator.mediaDevices.getUserMedia({video:true,audio:true});
    localV.srcObject = localStream;
    logStatus('Camera & mic ready');
  } catch(e){
    alert('Cannot access camera/mic: '+e.message);
  }
}

function createPeerConnection(peerId){
  const pc = new RTCPeerConnection({iceServers: stunServers});
  localStream.getTracks().forEach(track => pc.addTrack(track, localStream));

  // video for remote peer
  pc.ontrack = e => {
    if(peers[peerId].videoEl) return;
    const vid = document.createElement('video');
    vid.autoplay = true; vid.playsInline = true; vid.srcObject = e.streams[0];

    const tile = document.createElement('div');
    tile.className = 'tile';
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = 'Peer';
    tile.appendChild(vid);
    tile.appendChild(meta);
    grid.appendChild(tile);

    peers[peerId].videoEl = vid;
  };

  pc.oniceconnectionstatechange = ()=>logStatus(`ICE ${peerId}: ${pc.iceConnectionState}`);

  return pc;
}

function setupDataChannel(peerId, channel){
  peers[peerId].dc = channel;
  channel.onopen = () => addChat(`**connected to ${peerId}**`, 'system');
  channel.onmessage = ev => addChat(ev.data, `peer ${peerId}`);
}

sendChatBtn.onclick = ()=>{
  const msg = chatInput.value.trim();
  if(!msg) return;
  for(const p of Object.values(peers)){
    if(p.dc && p.dc.readyState === 'open') p.dc.send(msg);
  }
  addChat(msg,'me');
  chatInput.value='';
};

joinBtn.onclick = async ()=>{
  joinBtn.style.display='none';
  leaveBtn.style.display='inline-block';
  const roomName = roomInput.value.trim() || `room-${Math.floor(Math.random()*1000)}`;
  logStatus(`Joining ${roomName}`);

  // generate a unique id for self
  const myId = crypto.randomUUID();

  // insert self into rooms
  const insertResp = await supabase.from('rooms').insert([{id: myId, room: roomName, sdp: '', created_at: new Date()}]).select();
  if(insertResp.error){ console.error('Insert failed:', insertResp.error); alert('Join failed'); return; }

  // listen for new peers
  supabase.from(`rooms:room=eq.${roomName}`).on('INSERT', async payload=>{
    const peer = payload.new;
    if(peer.id === myId) return; // ignore self

    // create peer connection
    peers[peer.id] = {pc: createPeerConnection(peer.id)};
    const pc = peers[peer.id].pc;

    // data channel
    const dc = pc.createDataChannel('chat');
    setupDataChannel(peer.id, dc);

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    // update SDP in table
    await supabase.from('rooms').update({sdp: JSON.stringify(pc.localDescription)}).eq('id', peer.id);

    // send answer
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await supabase.from('rooms').update({sdp: JSON.stringify(pc.localDescription)}).eq('id', peer.id);
  }).subscribe();

  // listen for updates from others
  supabase.from(`rooms:room=eq.${roomName}`).on('UPDATE', async payload=>{
    const peer = payload.new;
    if(peer.id === myId) return;
    if(!peers[peer.id]) peers[peer.id] = {pc: createPeerConnection(peer.id)};
    const pc = peers[peer.id].pc;
    if(peer.sdp) await pc.setRemoteDescription(JSON.parse(peer.sdp));
  }).subscribe();

  logStatus('Connected — waiting for peers...');
};

leaveBtn.onclick = ()=>{
  for(const p of Object.values(peers)){
    p.pc?.close();
    if(p.videoEl) p.videoEl.remove();
  }
  peers={};
  joinBtn.style.display='inline-block';
  leaveBtn.style.display='none';
  logStatus('Left room');
};

(async()=>{ await startLocal(); })();
</script>

</body>
</html>
