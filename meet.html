<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SimpleMeet++ â€” Serverless Signaling (Glassmorphism)</title>
  <style>
    :root{--bg1:#071023;--bg2:#0b1a2b;--accent1:#7dd3fc;--accent2:#a78bfa;--muted:#98a8bf;--glass:rgba(255,255,255,0.06);--highlight:#7dd3fc}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto;color:#eaf2ff;background:linear-gradient(180deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased}
    .app{max-width:1200px;margin:20px auto;padding:18px;display:flex;flex-direction:column;gap:16px}
    header{display:flex;align-items:center;gap:14px}
    .brand{font-weight:800;font-size:20px;background:linear-gradient(90deg,var(--accent1),var(--accent2))text;color:transparent}
    .glass{background:var(--glass);border:1px solid rgba(255,255,255,0.06);backdrop-filter: blur(8px);padding:10px;border-radius:12px;color:var(--muted)}
    .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
    .btn-main{background:linear-gradient(90deg,var(--accent1),var(--accent2));color:#042135}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
    main{display:flex;gap:16px}
    .grid{flex:1;display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;padding:10px}
    .tile{position:relative;border-radius:14px;overflow:hidden;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.2));border:1px solid rgba(255,255,255,0.04);box-shadow:0 8px 30px rgba(2,6,23,0.6);transition:all 0.3s ease;aspect-ratio:16/9}
    .tile.speaking{border:3px solid var(--highlight);box-shadow:0 0 20px var(--highlight)}
    .tile video{width:100%;height:100%;object-fit:cover;display:block}
    .meta{position:absolute;left:10px;bottom:10px;padding:6px 10px;border-radius:999px;background:linear-gradient(90deg, rgba(0,0,0,0.5), rgba(0,0,0,0.25));font-weight:700;font-size:13px;display:flex;align-items:center;gap:4px}
    .emoji-reactions{position:absolute;top:10px;right:10px;display:flex;gap:4px}
    .emoji{cursor:pointer;font-size:20px;}
    .side{width:360px;display:flex;flex-direction:column;gap:12px}
    .panel{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.24));border:1px solid rgba(255,255,255,0.04);backdrop-filter:blur(10px)}
    textarea{width:100%;height:92px;background:transparent;border:1px dashed rgba(255,255,255,0.04);color:inherit;padding:8px;border-radius:8px}
    .chat-area{height:200px;overflow:auto;background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}
    .chat-input{display:flex;gap:8px;margin-top:8px}
    input[type=text]{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit}
    button.small{padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.02)}
    .status{font-size:13px;color:var(--muted)}
    @media (max-width:980px){.side{display:none}.grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">SimpleMeet++</div>
      <div class="glass">
        <label style="font-size:12px;color:var(--muted)">Room (optional)</label>
        <input id="room" placeholder="room-1" value="room-1" />
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button id="joinBtn" class="btn btn-main">Join</button>
        <button id="leaveBtn" class="btn btn-ghost" style="display:none">Leave</button>
      </div>
    </header>

    <main>
      <div class="grid" id="grid"></div>

      <aside class="side">
        <div class="panel">
          <h4 style="margin:0 0 8px 0">Preview</h4>
          <div class="tile" style="min-height:120px"><video id="local" autoplay muted playsinline></video><div class="meta">You</div></div>
        </div>

        <div class="panel">
          <h4 style="margin:0 0 8px 0">Serverless Signaling</h4>
          <div style="font-size:13px;color:var(--muted);margin-bottom:8px">No central server â€” exchange the generated blobs using any chat app (Discord, SMS, DM). Works across networks with public STUN servers.</div>
          <button id="createOffer" class="small">Create Offer (copy & send)</button>
          <div style="margin-top:8px;"><label style="font-size:12px;color:var(--muted)">Paste remote blob here</label><textarea id="remoteBlob" placeholder="Paste remote offer/answer blob"></textarea><button id="acceptRemote" class="small">Accept Remote</button></div>
        </div>

        <div class="panel">
          <h4 style="margin:0 0 8px 0">Chat (peer-to-peer)</h4>
          <div class="chat-area" id="chatArea"></div>
          <div class="chat-input"><input id="chatInput" type="text" placeholder="Say something..." /><button id="sendChat" class="small">Send</button></div>
        </div>

        <div class="panel">
          <h4 style="margin:0 0 8px 0">Status</h4>
          <div id="status" class="status">Idle â€” serverless mode</div>
        </div>
      </aside>
    </main>
  </div>

<script type="module">
const stunServers = [
  { urls: 'stun:stun.l.google.com:19302' },
  { urls: 'stun:stun1.l.google.com:19302' },
  { urls: 'stun:stun2.l.google.com:19302' }
];

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const SUPABASE_URL = 'https://wzaimsgnwsxgndlpyeiw.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind6YWltc2dud3N4Z25kbHB5ZWl3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQxMDQwODMsImV4cCI6MjA3OTY4MDA4M30.FNIBYc0GikZTJnKHW5FiqBfs7MwSB5nlnoMIlEFl8v0';
const supabase = createClient(SUPABASE_URL,SUPABASE_KEY);

const localV = document.getElementById('local');
const grid = document.getElementById('grid');
const statusEl = document.getElementById('status');
const createOfferBtn = document.getElementById('createOffer');
const remoteBlobTa = document.getElementById('remoteBlob');
const acceptRemoteBtn = document.getElementById('acceptRemote');
const chatArea = document.getElementById('chatArea');
const chatInput = document.getElementById('chatInput');
const sendChatBtn = document.getElementById('sendChat');
const joinBtn = document.getElementById('joinBtn');
const leaveBtn = document.getElementById('leaveBtn');

let localStream = null;
let pc = null;
let dc = null;
let isOfferer = false;
const peers = {};

function logStatus(s){ statusEl.textContent = s }
function addChat(msg,from='me'){ const el = document.createElement('div'); el.textContent = (from? from+': ':'')+msg; el.style.padding='6px 4px'; el.style.fontSize='13px'; chatArea.appendChild(el); chatArea.scrollTop = chatArea.scrollHeight }

async function startLocal(){ try{ localStream = await navigator.mediaDevices.getUserMedia({video:{width:{ideal:1280}}, audio:true}); localV.srcObject = localStream; logStatus('Got local camera'); createOfferBtn.disabled = false; }catch(e){ alert('Camera/Mic not available: '+e.message) } }
startLocal();

function makePC(){
  const _pc = new RTCPeerConnection({iceServers:stunServers});
  if(localStream) localStream.getTracks().forEach(t=>_pc.addTrack(t,localStream));

  _pc.ontrack = (e)=>{
    const id = 'peer-'+Math.random().toString(36).slice(2,8);
    const wrap = document.createElement('div'); wrap.className='tile';
    const v = document.createElement('video'); v.autoplay=true; v.playsInline=true; v.srcObject = e.streams[0];
    const meta = document.createElement('div'); meta.className='meta'; meta.textContent = id;

    const emojiDiv = document.createElement('div'); emojiDiv.className='emoji-reactions';
    ['ðŸ‘','ðŸ˜‚','ðŸŽ‰','â¤ï¸'].forEach(em=>{ const span=document.createElement('span'); span.className='emoji'; span.textContent=em; span.onclick=()=>{ alert(`Reacted with ${em}`) }; emojiDiv.appendChild(span) });

    wrap.appendChild(v); wrap.appendChild(meta); wrap.appendChild(emojiDiv);
    grid.appendChild(wrap);
    peers[id] = {el:wrap, video:v};
  };

  _pc.oniceconnectionstatechange = ()=>{ logStatus('ICE: '+_pc.iceConnectionState) };

  return _pc;
}

createOfferBtn.onclick = async ()=>{
  if(!localStream){ alert('Local media not ready'); return; }
  isOfferer = true;
  pc = makePC();
  dc = pc.createDataChannel('chat'); setupDataChannel(dc);

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  logStatus('Gathering ICE candidates...');
  await waitForIceGatheringComplete(pc);
  const blob = { type:'offer', sdp: pc.localDescription }; remoteBlobTa.value = btoa(JSON.stringify(blob));
  logStatus('Offer created â€” copy the blob and send to remote');
}

function waitForIceGatheringComplete(pcInner){ return new Promise(resolve=>{
  if(pcInner.iceGatheringState==='complete') return resolve();
  function check(){ if(pcInner.iceGatheringState==='complete'){ pcInner.removeEventListener('icegatheringstatechange',check); resolve(); } }
  pcInner.addEventListener('icegatheringstatechange',check);
  setTimeout(()=>{ try{ pcInner.removeEventListener('icegatheringstatechange',check) }catch{}; resolve(); },6000);
});}

acceptRemoteBtn.onclick = async ()=>{
  const txt = remoteBlobTa.value.trim(); if(!txt) return alert('Paste a blob first');
  let pkt = null; try{ pkt=JSON.parse(atob(txt)); }catch(e){ return alert('Invalid blob') }
  if(pkt.type==='offer'){
    pc = makePC(); pc.ondatachannel=(ev)=>{ dc=ev.channel; setupDataChannel(dc); };
    await pc.setRemoteDescription(new RTCSessionDescription(pkt.sdp));
    const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
    logStatus('Gathering ICE candidates for answer...');
    await waitForIceGatheringComplete(pc);
    remoteBlobTa.value = btoa(JSON.stringify({type:'answer', sdp:pc.localDescription}));
    logStatus('Answer created â€” copy this blob back to the offerer');
  } else if(pkt.type==='answer'){
    if(!isOfferer || !pc) return alert('You must create offer first');
    await pc.setRemoteDescription(new RTCSessionDescription(pkt.sdp));
    logStatus('Remote answer set â€” connection should establish shortly');
  } else alert('Unknown blob type');
}

function setupDataChannel(ch){
  ch.onopen=()=>{ logStatus('DataChannel open â€” chat available'); addChat('**connected**','system'); }
  ch.onmessage=(ev)=>{ addChat(ev.data,'peer'); }
  ch.onclose=()=>{ logStatus('DataChannel closed'); }
}
sendChatBtn.onclick=()=>{
  const msg=chatInput.value.trim(); if(!msg) return; if(dc && dc.readyState==='open'){ dc.send(msg); addChat(msg,'me'); chatInput.value=''; }else alert('Data channel not open yet');
}
remoteBlobTa.addEventListener('dblclick',()=>{ remoteBlobTa.select(); document.execCommand('copy'); alert('copied') });
joinBtn.onclick=()=>{ joinBtn.style.display='none'; leaveBtn.style.display='inline-block'; logStatus('Manual mode: use Create Offer or paste remote blob'); }
leaveBtn.onclick=()=>{ leaveBtn.style.display='none'; joinBtn.style.display='inline-block'; logStatus('Idle'); try{ if(pc) pc.close(); }catch{} }

// ---------------------- Auto-join using URL ----------------------
const urlParams = new URLSearchParams(window.location.search);
const roomName = urlParams.get('room') || 'room-1';
const roomInput = document.getElementById('room');

roomInput.value = roomName;

joinBtn.onclick = async ()=>{
  joinBtn.style.display='none'; leaveBtn.style.display='inline-block';
  logStatus('Joining room: '+roomName);
  pc = makePC();

  const { data: existing } = await supabase.from('rooms').select('*').eq('room',roomName).single();
  if(!existing){
    isOfferer=true;
    dc = pc.createDataChannel('chat'); setupDataChannel(dc);
    const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
    await supabase.from('rooms').upsert({room:roomName,sdp:JSON.stringify(pc.localDescription)});
    logStatus('Created offer, waiting for answer...');
    supabase.from(`rooms:room=eq.${roomName}`).on('UPDATE', payload => {
      console.log('Room update!', payload)
      if (!isOfferer) {
          const ans = JSON.parse(payload.new.sdp);
          pc.setRemoteDescription(ans);
          logStatus('Answer received â€” connected!');
      }
  })
  .subscribe();

  } else {
    await pc.setRemoteDescription(JSON.parse(existing.sdp));
    pc.ondatachannel=ev=>{ dc=ev.channel; setupDataChannel(dc); };
    const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
    await supabase.from('rooms').upsert({room:roomName,sdp:JSON.stringify(pc.localDescription)});
    logStatus('Answered offer â€” connected!');
  }
};

async function init() {
  await startLocal();
  if(roomName) joinBtn.click();
}
init();


</script>
</body>
</html>
